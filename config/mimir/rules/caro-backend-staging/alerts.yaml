# Mimir Alert Rules
# 공식 문서: https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/

groups:
  - name: caro_demo_alerts
    interval: 30s
    rules:
      - alert: CaroDemoDown
        expr: absent_over_time(application_ready_time_milliseconds{job="caro-demo-app"}[3m])
        for: 1m
        labels:
          severity: critical
          service: caro-demo-app
          cluster: local
        annotations:
          summary: "Caro Demo가 다운되었습니다"
          description: "Caro Demo의 application_ready_time 메트릭이 3분 이상 수신되지 않습니다. 애플리케이션이 중단되었을 수 있으므로 즉시 확인이 필요합니다."

      - alert: HighLatencyBurnRate
        expr: |
          (
            (1 - histogram_fraction(0, 500, sum(rate(http_server_requests_milliseconds{job="caro-demo-app"}[1h])))) > 14.4 * 0.01
          )
          and
          (
            (1 - histogram_fraction(0, 500, sum(rate(http_server_requests_milliseconds{job="caro-demo-app"}[5m])))) > 14.4 * 0.01
          )
        for: 2m
        labels:
          severity: critical
          service: caro-demo-app
          cluster: local
        annotations:
          summary: "레이턴시 SLO 에러 버짓이 빠르게 소진되고 있습니다"
          description: "SLO(99% < 500ms) 기준 burn rate가 14.4x를 초과했습니다. 이 속도면 2일 만에 한 달치 에러 버짓이 소진됩니다. 즉시 확인이 필요합니다."

      - alert: HighP95LatencyByEndpoint
        expr: |
          (
            histogram_quantile(0.95, sum by (uri) (rate(http_server_requests_milliseconds{job="caro-demo-app"}[5m]))) > 1000
          )
          and
          (
            sum by (uri) (histogram_count(rate(http_server_requests_milliseconds{job="caro-demo-app"}[5m]))) > 0.01
          )
        for: 2m
        labels:
          severity: warning
          service: caro-demo-app
          cluster: local
        annotations:
          summary: "엔드포인트 {{ $labels.uri }}의 P95 레이턴시가 높습니다"
          description: "{{ $labels.uri }}의 P95 레이턴시가 {{ $value | humanize }}ms입니다. 정상 범위는 1000ms 미만입니다."

      - alert: HighHTTPErrorRateByEndpoint
        expr: |
          (
            (
              sum by (uri) (histogram_count(rate(http_server_requests_milliseconds{job="caro-demo-app",status=~"5.."}[5m])))
              /
              sum by (uri) (histogram_count(rate(http_server_requests_milliseconds{job="caro-demo-app"}[5m])))
            ) * 100 > 5
          )
          and
          (
            sum by (uri) (histogram_count(rate(http_server_requests_milliseconds{job="caro-demo-app"}[5m]))) > 0.01
          )
        for: 5m
        labels:
          severity: warning
          service: caro-demo-app
          cluster: local
        annotations:
          summary: "엔드포인트 {{ $labels.uri }}의 HTTP 5xx 에러율이 높습니다"
          description: "{{ $labels.uri }}의 최근 5분간 HTTP 5xx 에러율이 {{ $value | humanize }}%입니다."
